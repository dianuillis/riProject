<?xml version="1.0" encoding="UTF-8"?>
<!-- generated by CLiX/Wiki2XML [MPI-Inf, MMCI@UdS] $LastChangedRevision: 92 $ on 16.04.2009 21:21:02[mciao0826] -->
<!DOCTYPE article SYSTEM "../article.dtd">
<article xmlns:xlink="http://www.w3.org/1999/xlink">
<header>
<title>NTP server misuse and abuse</title>
<id>4684241</id>
<revision>
<id>237028852</id>
<timestamp>2008-09-08T08:41:58Z</timestamp>
<contributor>
<username>Nexm0d</username>
<id>414640</id>
</contributor>
</revision>
<categories>
<category>Network time-related software</category>
</categories>
</header>
<bdy>

<b>NTP server misuse and abuse</b> covers a number of practices which cause damage or degradation to an <message wordnetid="106598915" confidence="0.8">
<protocol wordnetid="106665108" confidence="0.8">
<standard wordnetid="107260623" confidence="0.8">
<direction wordnetid="106786629" confidence="0.8">
<rule wordnetid="106652242" confidence="0.8">
<system_of_measurement wordnetid="113577171" confidence="0.8">
<link xlink:type="simple" xlink:href="../886/159886.xml">
NTP</link></system_of_measurement>
</rule>
</direction>
</standard>
</protocol>
</message>
 server, ranging from flooding it with traffic (effectively a <link>
DDoS</link> attack) or violating the server's access policy or the NTP <weblink xlink:type="simple" xlink:href="http://support.ntp.org/Servers/RulesOfEngagement">
rules of engagement</weblink>. One incident was branded <b>NTP vandalism</b> in an <link xlink:type="simple" xlink:href="../321/969321.xml">
open letter</link> from <physical_entity wordnetid="100001930" confidence="0.8">
<person wordnetid="100007846" confidence="0.8">
<computer_user wordnetid="109951274" confidence="0.8">
<programmer wordnetid="110481268" confidence="0.8">
<engineer wordnetid="109615807" confidence="0.8">
<causal_agent wordnetid="100007347" confidence="0.8">
<link xlink:type="simple" xlink:href="../165/1828165.xml">
Poul-Henning Kamp</link></causal_agent>
</engineer>
</programmer>
</computer_user>
</person>
</physical_entity>
 to the <link xlink:type="simple" xlink:href="../748/25748.xml">
router</link> manufacturer <company wordnetid="108058098" confidence="0.9508927676800064">
<link xlink:type="simple" xlink:href="../742/1024742.xml">
D-Link</link></company>
 in 2006. This term has later been extended by others to retroactively include other incidents. There is, however, no evidence that any of these problems are deliberate vandalism. They are more usually caused by shortsighted or poorly chosen default configurations.
<sec>
<st>
Common NTP client problems</st>
<p>

The most troublesome problems have involved NTP server addresses hardcoded in the <link xlink:type="simple" xlink:href="../155/41155.xml">
firmware</link> of consumer networking devices. As major manufacturers produce hundreds of thousands of devices and since most customers never upgrade the firmware, any problems will persist for as long as the devices are in service.</p>
<p>

One particularly common software error is to generate query packets at short (less than five second) intervals until a response is received.  When such an implementation finds itself behind a <link xlink:type="simple" xlink:href="../296/1362296.xml">
packet filter</link> that refuses to pass the incoming response, this results in a never-ending stream of requests to the NTP server.  Such grossly over-eager clients (particularly those polling once per second) commonly make up more than 50% of the traffic of public NTP servers, despite being a minuscule fraction of the total clients. While it is reasonable to send a few initial packets at short intervals, it is essential for the health of <it>any</it> connectionless network that unacknowledged packets be generated at exponentially decreasing rates.  This applies to any connectionless protocol, and many portions of connection-based protocols.  Examples can be found in the <link xlink:type="simple" xlink:href="../538/30538.xml">
TCP</link> specification for connection establishment, zero-window probing, and keepalive transmissions.</p>

</sec>
<sec>
<st>
Tardis and Trinity College, Dublin</st>
<p>

In October 2002, one of the earliest known cases of time server misuse resulted in problems for a web server at <university wordnetid="108286163" confidence="0.9508927676800064">
<link xlink:type="simple" xlink:href="../298/142298.xml">
Trinity College, Dublin</link></university>
. The traffic was ultimately traced to misbehaving copies of a program called <weblink xlink:type="simple" xlink:href="http://www.kaska.demon.co.uk/tardis.htm">
Tardis</weblink>, with thousands of copies around the world contacting the web server and obtaining a timestamp via HTTP.  Ultimately, the solution was to modify the web server configuration so as to deliver a customized version of the home page (greatly reduced in size) and to return a bogus time value, which caused most of the clients to choose a different time server.  An updated version of Tardis was later released to correct for this problem.  This incident was described by <weblink xlink:type="simple" xlink:href="http://www.usenix.org/publications/login/2006-04/pdfs/malone.pdf">
David Malone</weblink> in the April 2006 issue of <weblink xlink:type="simple" xlink:href="http://www.usenix.org/publications/login/">
<list>
<entry level="1" type="definition">

login:</entry>
</list>
</weblink> magazine, published by the <weblink xlink:type="simple" xlink:href="http://www.usenix.org/">
USENIX Association</weblink>.</p>

</sec>
<sec>
<st>
NETGEAR and the University of Wisconsin-Madison</st>
<p>

The first widely known case of NTP server problems began in May 2003, when <link xlink:type="simple" xlink:href="../294/1197294.xml">
NETGEAR</link>'s hardware products flooded the <university wordnetid="108286163" confidence="0.9508927676800064">
<link xlink:type="simple" xlink:href="../711/347711.xml">
University of Wisconsin-Madison</link></university>
's <link xlink:type="simple" xlink:href="../886/159886.xml">
NTP server</link> with requests.<ref xlink:type="simple" xlink:href="#xpointer(//reflist/entry[@id=%221%22])">1</ref>  University personnel initially assumed this was a malicious <link>
distributed denial of service</link> attack and took actions to block the flood at their network border.  Rather than abating (as most DDOS attacks do) the flow increased, reaching 250,000 packets-per-second (150 megabits per second) by June.  Subsequent investigation revealed that four models of NETGEAR routers were the source of the problem. It was found that the SNTP (Simple NTP) client in the routers has two serious flaws.  First, it relies on a single NTP server (at the University of Wisconsin-Madison) whose IP address was hard-coded in the firmware.  Second, it polls the server at one second intervals until it receives a response.  A total of 707,147 products with the faulty client were produced.</p>
<p>

NETGEAR has released firmware updates for the affected products (DG814, HR314, MR814 and RP614) which query NETGEAR's own servers, poll only once every ten minutes, and give up after five failures.  While this update fixes the flaws in the original SNTP client, it does not solve the larger problem.  Most consumers will never update their router's firmware, particularly if the device seems to be operating properly.  The University of Wisconsin-Madison NTP server continues to receive high levels of traffic from NETGEAR routers, with occasional floods of up to 100,000 packets-per-second.  NETGEAR has donated $375,000 to the University of Wisconsin-Madison's Division of Information Technology for their help in identifying the flaw.</p>

</sec>
<sec>
<st>
SMC and CSIRO</st>
<p>

Also in 2003, another case forced the NTP servers of the <country wordnetid="108544813" confidence="0.9508927676800064">
<link xlink:type="simple" xlink:href="../264/4689264.xml">
Australia</link></country>
n Commonwealth Scientific and Research Organization's (CSIRO) National Measurement Laboratory to close to the public<weblink xlink:type="simple" xlink:href="http://www.taborcommunications.com/hpcwire/hpcwireWWW/03/0711/105537.html">
http://www.taborcommunications.com/hpcwire/hpcwireWWW/03/0711/105537.html</weblink>. The traffic was shown to come from a bad <message wordnetid="106598915" confidence="0.8">
<protocol wordnetid="106665108" confidence="0.8">
<standard wordnetid="107260623" confidence="0.8">
<direction wordnetid="106786629" confidence="0.8">
<rule wordnetid="106652242" confidence="0.8">
<system_of_measurement wordnetid="113577171" confidence="0.8">
<link xlink:type="simple" xlink:href="../886/159886.xml">
NTP</link></system_of_measurement>
</rule>
</direction>
</standard>
</protocol>
</message>
 implementation in some <company wordnetid="108058098" confidence="0.9508927676800064">
<link xlink:type="simple" xlink:href="../096/8105096.xml">
SMC</link></company>
 router models where the IP address of the CSIRO server was embedded in the firmware. SMC has released firmware updates for the products: the 7004VBR and 7004VWBR models are known to be affected.</p>

</sec>
<sec>
<st>
D-Link and Poul-Henning Kamp</st>
<p>

The history of the most recent problem started in 2005 when <physical_entity wordnetid="100001930" confidence="0.8">
<person wordnetid="100007846" confidence="0.8">
<computer_user wordnetid="109951274" confidence="0.8">
<programmer wordnetid="110481268" confidence="0.8">
<engineer wordnetid="109615807" confidence="0.8">
<causal_agent wordnetid="100007347" confidence="0.8">
<link xlink:type="simple" xlink:href="../165/1828165.xml">
Poul-Henning Kamp</link></causal_agent>
</engineer>
</programmer>
</computer_user>
</person>
</physical_entity>
, the manager of the only <country wordnetid="108544813" confidence="0.9508927676800064">
<link xlink:type="simple" xlink:href="../972/76972.xml">
Danish</link></country>
 Stratum 1 NTP server available to the general public, observed a huge rise in traffic and discovered that between 75 and 90% was originating with D-Link's router products. Stratum 1 NTP servers receive their time signal from an accurate external source, such as a GPS receiver, radio clock, or a calibrated atomic clock. By convention, Stratum 1 time servers should only be used by Stratum 2 servers, and by applications requiring extremely precise time measurements, such as scientific applications.<ref xlink:type="simple" xlink:href="#xpointer(//reflist/entry[@id=%222%22])">2</ref> A home networking router does not meet either of these criteria. In addition, Kamp's server's access policy explicitly limited it to servers directly connected to the <link xlink:type="simple" xlink:href="../424/1872424.xml">
Danish Internet Exchange</link> (DIX). The direct use of this and other Stratum 1 servers by D-Link's routers resulted in a huge rise in traffic, increasing bandwidth costs and server load.</p>
<p>

In many countries, official timekeeping services are provided by a government agency (such as <link xlink:type="simple" xlink:href="../888/21888.xml">
NIST</link> in the <link xlink:type="simple" xlink:href="../750/3434750.xml">
U.S.</link>). Since there is no Danish equivalent, Kamp provides his time service "<link xlink:type="simple" xlink:href="../839/154839.xml">
pro bono publico</link>". In return, DIX agreed to provide a free connection for his time server under the assumption that the bandwidth involved would be relatively low, given the limited number of servers and potential clients. With the increased traffic caused by the D-Link routers, DIX requested he pay a yearly connection fee of <currency wordnetid="113385913" confidence="0.9508927676800064">
<link xlink:type="simple" xlink:href="../323/236323.xml">
DKK</link></currency>
 54,000 (approximately $8,800 <link xlink:type="simple" xlink:href="../338/18717338.xml">
USD</link>).</p>
<p>

Kamp contacted D-Link in November 2005, hoping to get them to fix the problem and compensate him for the time and money he spent tracking down the problem and the bandwidth charges caused by D-Link products. The company denied any problem, accused him of extortion, and offered an amount in compensation which Kamp asserted did not cover his expenses. On <link xlink:type="simple" xlink:href="../735/2735.xml">
April 7</link>, <link xlink:type="simple" xlink:href="../164/36164.xml">
2006</link> Kamp posted the story on his website. The story was picked up by <web_site wordnetid="106359193" confidence="0.9508927676800064">
<link xlink:type="simple" xlink:href="../715/26715.xml">
Slashdot</link></web_site>
<ref xlink:type="simple" xlink:href="#xpointer(//reflist/entry[@id=%223%22])">3</ref>, <link xlink:type="simple" xlink:href="../005/3829005.xml">
reddit</link> and other news sites. After going public, Kamp realized that D-Link routers were directly querying other Stratum 1 time servers, violating the access policies of at least 43 of them in the process. On <link xlink:type="simple" xlink:href="../ury/24th_century.xml">
April 27</link> <link xlink:type="simple" xlink:href="../164/36164.xml">
2006</link>, D-Link and Kamp announced that they had "amicably
resolved" their dispute.<ref xlink:type="simple" xlink:href="#xpointer(//reflist/entry[@id=%224%22])">4</ref></p>

</sec>
<sec>
<st>
Technical solutions</st>
<p>

After these incidents, it became clear that apart from stating a server’s access policy, a technical means of enforcing a policy was needed. One such mechanism was provided by extending semantics of a <it>Reference Identifier field</it> in an NTP packet when a <it>Stratum field</it> is 0.</p>
<p>

In January 2006, RFC 4330 was published, updating details of the <link xlink:type="simple" xlink:href="../886/159886.xml">
SNTP</link> protocol, but also provisionally clarifying and extending the related NTP protocol in some areas. Sections 8 to 11 of RFC 4330 are of particular relevance to this topic (The Kiss-o'-Death Packet, On Being a Good Network Citizen, Best Practices, Security Considerations). Section 8 introduces Kiss-o'-Death packets:</p>
<p>

<indent level="1">

"In NTPv4 and SNTPv4, packets of this kind are called Kiss-o'-Death (KoD) packets, and the ASCII messages they convey are called kiss codes. The KoD packets got their name because an early use was to tell clients to stop sending packets that violate server access controls."
</indent>

Unfortunately the new requirements of the NTP protocol do not work retroactively, and old clients and implementations of earlier version of the protocol do not recognize KoD and act on it. For the time being there are no good technical means to counteract misuse of NTP servers.</p>

</sec>
<sec>
<st>
References</st>

<p>

<reflist>
<entry id="1">
<weblink xlink:type="simple" xlink:href="http://www.cs.wisc.edu/~plonka/netgear-sntp/">
Flawed Routers Flood  University of Wisconsin Internet Time Server, Netgear Cooperating with University on a Resolution</weblink> Dave Plonka, August 21, 2003 - University of Wisconsin-Madison. Updated 2006/07/19</entry>
<entry id="2">
<weblink xlink:type="simple" xlink:href="http://www.oreillynet.com/onlamp/blog/2006/02/help_save_the_endangered_time.html">
Help save the endangered time servers</weblink> retrieved <link xlink:type="simple" xlink:href="../332/1332.xml">
August 7</link>, <link xlink:type="simple" xlink:href="../165/36165.xml">
2007</link></entry>
<entry id="3">
<weblink xlink:type="simple" xlink:href="http://yro.slashdot.org/article.pl?sid=06/04/07/130209">
D-Link Firmware Abuses Open NTP Servers</weblink> retrieved <link xlink:type="simple" xlink:href="../332/1332.xml">
August 7</link>, <link xlink:type="simple" xlink:href="../165/36165.xml">
2007</link></entry>
<entry id="4">
<weblink xlink:type="simple" xlink:href="http://people.freebsd.org/~phk/dlink/">
Open Letter to D-Link about their NTP Vandalism: 2006-04-27 Update</weblink> retrieved <link xlink:type="simple" xlink:href="../332/1332.xml">
August 7</link>, <link xlink:type="simple" xlink:href="../165/36165.xml">
2007</link></entry>
</reflist>
</p>

</sec>
<sec>
<st>
External links</st>
<p>

<list>
<entry level="1" type="bullet">

 http://www.usenix.org/publications/login/2006-04/pdfs/malone.pdf - The Trinity College incident (requires login)</entry>
<entry level="2" type="bullet">

 Above article also available here (without login): http://www.maths.tcd.ie/~dwmalone/p/login06.pdf</entry>
<entry level="1" type="bullet">

 http://www.taborcommunications.com/hpcwire/hpcwireWWW/03/0711/105537.html - SMC/CSIRO Incident</entry>
<entry level="1" type="bullet">

 http://people.freebsd.org/~phk/dlink/ - Poul-Henning Kamp's open letter to D-Link (changed on <link xlink:type="simple" xlink:href="../ury/24th_century.xml">
27 April</link> <link xlink:type="simple" xlink:href="../164/36164.xml">
2006</link>)</entry>
<entry level="1" type="bullet">

 http://www.lightbluetouchpaper.org/2006/04/07/when-firmware-attacks-ddos-by-d-link/ - When Firmware Attacks! (DDoS by D-Link) by Richard Clayton</entry>
<entry level="1" type="bullet">

 http://www.osnews.com/story.php?news_id=14278 - OSnews' article on "NTP vandalism"</entry>
<entry level="1" type="bullet">

 http://www.engadget.com/2006/04/09/danish-server-admin-exposes-d-links-ntp-vandalism/ - Engadget on "NTP vandalism"</entry>
</list>
</p>


</sec>
</bdy>
</article>
